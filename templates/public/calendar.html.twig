{% extends 'base.html.twig' %}

{% block title %}{{ paroisse.nom }} - Amissa{% endblock %}

{% block body %}
    {% include '_navbar.html.twig' %}
    <div class="container">
        <a href="{{ path('public_home') }}" style="color: #6b7280; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 1rem;">
            &larr; Retour aux paroisses
        </a>

        <h1 class="page-title">{{ paroisse.nom }}</h1>
        <p class="page-subtitle">{{ paroisse.diocese.nom }} - {{ paroisse.adresse }}</p>

        <div class="calendar-layout">
            <!-- Calendar on the left -->
            <div class="card" style="padding: 1rem;">
                <div id="calendar-container">
                    {% set today = "now"|date('Y-m-d') %}
                    {% set currentMonth = selectedDate|date('Y-m') %}
                    {% set firstDayOfMonth = selectedDate|date('Y-m-01') %}
                    {% set lastDayOfMonth = selectedDate|date('Y-m-t') %}
                    {% set daysInMonth = selectedDate|date('t') %}
                    {% set firstDayWeekday = (firstDayOfMonth|date('N')) %}

                    <!-- Month navigation -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        {% set prevMonth = selectedDate|date_modify('-1 month')|date('Y-m-d') %}
                        {% set nextMonth = selectedDate|date_modify('+1 month')|date('Y-m-d') %}
                        <a href="{{ path('public_paroisse_calendar', {id: paroisse.id, date: prevMonth}) }}"
                           style="padding: 0.5rem; color: #374151; text-decoration: none; font-size: 1.25rem;">&larr;</a>
                        <span style="font-weight: 600; font-size: 1rem;">
                            {{ selectedDate|date('F Y')|capitalize }}
                        </span>
                        <a href="{{ path('public_paroisse_calendar', {id: paroisse.id, date: nextMonth}) }}"
                           style="padding: 0.5rem; color: #374151; text-decoration: none; font-size: 1.25rem;">&rarr;</a>
                    </div>

                    <!-- Weekday headers -->
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); text-align: center; margin-bottom: 0.5rem;">
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Lun</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Mar</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Mer</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Jeu</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Ven</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Sam</div>
                        <div style="font-size: 0.75rem; color: #6b7280; font-weight: 600;">Dim</div>
                    </div>

                    <!-- Calendar days -->
                    <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px;">
                        <!-- Empty cells for days before month starts -->
                        {% for i in 1..(firstDayWeekday - 1) %}
                            <div style="aspect-ratio: 1; padding: 0.25rem;"></div>
                        {% endfor %}

                        <!-- Days of the month -->
                        {% for day in 1..daysInMonth %}
                            {% set dateStr = selectedDate|date('Y-m') ~ '-' ~ (day < 10 ? '0' ~ day : day) %}
                            {% set isSelected = dateStr == selectedDate|date('Y-m-d') %}
                            {% set isToday = dateStr == today %}
                            {% set hasMasses = datesWithMasses[dateStr] is defined %}
                            {% set massCount = datesWithMasses[dateStr]|default(0) %}

                            <a href="{{ path('public_paroisse_calendar', {id: paroisse.id, date: dateStr}) }}"
                               style="aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; text-decoration: none; border-radius: 0.375rem; font-size: 0.875rem; position: relative;
                                      {% if isSelected %}background: #111827; color: white;
                                      {% elseif isToday %}background: #f3f4f6; color: #111827; font-weight: 600;
                                      {% else %}color: #374151;{% endif %}
                                      {% if hasMasses and not isSelected %}border: 2px solid #10b981;{% endif %}">
                                {{ day }}
                                {% if hasMasses %}
                                    <span style="position: absolute; bottom: 2px; width: 6px; height: 6px; background: {% if isSelected %}white{% else %}#10b981{% endif %}; border-radius: 50%;"></span>
                                {% endif %}
                            </a>
                        {% endfor %}
                    </div>
                </div>

                <!-- Legend -->
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                        <span style="width: 12px; height: 12px; background: #10b981; border-radius: 50%;"></span>
                        Messes disponibles
                    </div>
                </div>
            </div>

            <!-- Masses on the right -->
            <div class="card">
                <h2 class="card-title">
                    Messes du {{ selectedDate|date('d/m/Y') }}
                    {% if selectedDate|date('Y-m-d') == "now"|date('Y-m-d') %}
                        <span style="font-size: 0.875rem; font-weight: normal; color: #6b7280;">(Aujourd'hui)</span>
                    {% endif %}
                </h2>
                <p class="text-sm text-gray-500" style="margin-bottom: 1.5rem;">
                    Les intentions doivent etre soumises au moins {{ paroisse.delaiMinimumJours }} jours avant la messe.
                </p>

                {% if occurrences is empty %}
                    <div class="text-center text-gray-500" style="padding: 3rem;">
                        <p style="font-size: 3rem; margin-bottom: 1rem;">&#128197;</p>
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Aucune messe disponible</p>
                        <p>Selectionnez une autre date ou revenez plus tard.</p>
                    </div>
                {% else %}
                    <div style="display: grid; gap: 1rem;">
                        {% for occurrence in occurrences %}
                            <div class="masse-item">
                                <div class="flex items-center gap-4">
                                    <div class="masse-time">
                                        {{ occurrence.dateHeure|date('H:i') }}
                                    </div>
                                    <div>
                                        <div class="font-semibold">{{ occurrence.messe.titre }}</div>
                                        <div class="text-sm text-gray-500">
                                            Montant suggéré: {{ occurrence.messe.montantSuggere|number_format(0, ',', ' ') }} FCFA
                                        </div>
                                    </div>
                                </div>
                                <a href="{{ path('public_intention_new', {occurrenceId: occurrence.id}) }}" class="btn btn-primary">
                                    Soumettre intention
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <style>
        .calendar-layout {
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 1.5rem;
            align-items: start;
        }
        .masse-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            background: #f9fafb;
            gap: 1rem;
        }
        .masse-time {
            width: 48px;
            height: 48px;
            background: #111827;
            color: white;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.25rem;
            flex-shrink: 0;
        }
        @media (max-width: 768px) {
            .calendar-layout {
                grid-template-columns: 1fr !important;
            }
            .masse-item {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }
            .masse-item .flex {
                flex-direction: column;
                align-items: center;
            }
            .masse-time {
                width: 100%;
                height: auto;
                padding: 0.75rem;
                font-size: 1.5rem;
            }
            .masse-item .btn {
                width: 100%;
                margin-top: 0.5rem;
            }
        }
    </style>
{% endblock %}
